{
  "description": "Règles d'harmonisation des schémas de données pour consolider AZ et AZEC vers un format commun",
  "az_harmonization": {
    "description": "Les données AZ utilisent déjà le schéma cible, donc mappage minimal requis",
    "rename": {
      "cdcoas": "cdcoass",
      "partcie": "part_cie",
      "primeto": "primes_ptf_intemp",
      "cotis_100": "primes_ptf_100_intemp"
    },
    "computed": {}
  },
  "azec_harmonization": {
    "description": "Conversion des colonnes AZEC vers le schéma consolidé commun",
    "rename": {
      "police": "nopol",
      "produit": "cdprod",
      "intermed": "noint",
      "codecoas": "cdcoass",
      "partcie": "part_cie",
      "primeto": "primes_ptf_intemp",
      "cotis_100": "primes_ptf_100_intemp",
      "effetpol": "dtcrepol",
      "datfin": "dtresilp",
      "datresil": "dttraar",
      "poingest": "ptgst",
      "mtca": "mtca",
      "code_naf": "cdnaf",
      "code_tre": "cdtre",
      "motifres": "cdcasres",
      "nomcli": "nmclt",
      "lidirisq": "lidirisq"
    },
    "computed": {
      "nopolli1": {
        "type": "alias",
        "source": "police",
        "description": "AZEC uses same field for both NOPOL and NOPOLLI1"
      },
      "mois_echeance": {
        "type": "month_extract",
        "source": "dtechann",
        "description": "Extract month from anniversary date"
      },
      "jour_echeance": {
        "type": "day_extract",
        "source": "dtechann",
        "description": "Extract day from anniversary date"
      },
      "cdsitp": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC"
      },
      "cdreg": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC"
      },
      "cdgecent": {
        "type": "constant",
        "value": null,
        "description": "Numeric missing for AZEC"
      },
      "cdpolrvi": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC"
      },
      "noclt": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC in consolidation"
      },
      "cdfract": {
        "type": "constant",
        "value": null,
        "description": "Empty risk address/contract fields for AZEC"
      },
      "quarisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "nmrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "nmsrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "resrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "ruerisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "posrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "vilrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "dteffan": {
        "type": "alias",
        "source": "effetpol",
        "description": "AZEC uses EFFETPOL for DTEFFAN"
      },
      "dttraan": {
        "type": "alias",
        "source": "effetpol",
        "description": "AZEC uses EFFETPOL for DTTRAAN"
      },
      "actprin": {
        "type": "constant",
        "value": null,
        "description": "AZ-only; AZEC default empty"
      },
      "ctprvtrv": {
        "type": "constant",
        "value": null,
        "description": "Numeric missing"
      },
      "mtsmpr": {
        "type": "constant",
        "value": null,
        "description": "Numeric missing"
      },
      "lbnattrv": {
        "type": "constant",
        "value": null,
        "description": "AZ-only; AZEC default empty"
      },
      "nbrpt": {
        "type": "constant",
        "value": 0,
        "description": "No RPT logic in AZEC"
      },
      "nbrpc": {
        "type": "constant",
        "value": 0,
        "description": "No RPC logic in AZEC"
      },
      "primes_rpc": {
        "type": "constant",
        "value": 0,
        "description": "No RPC primes in AZEC"
      },
      "primes_rpt": {
        "type": "constant",
        "value": 0,
        "description": "No RPT primes in AZEC"
      },
      "mtcaenp": {
        "type": "constant",
        "value": 0,
        "description": "Capital field not in AZEC"
      },
      "mtcasst": {
        "type": "constant",
        "value": 0,
        "description": "Capital field not in AZEC"
      },
      "mtcavnt": {
        "type": "constant",
        "value": 0,
        "description": "Capital field not in AZEC"
      },
      "cdnaf2008": {
        "type": "alias",
        "source": "code_naf",
        "description": "Temporary NAF2008 from AZEC (finalization handled by ISIC pipeline)"
      },
      "top_temp": {
        "type": "constant",
        "value": 0,
        "description": "Temporary flag - always 0 for AZEC"
      },
      "cdmotres": {
        "type": "mapping",
        "source": "origres",
        "mapping": {
          "CL": "A",
          "AP": "C",
          "CI": "Z",
          "": null
        },
        "default": "X",
        "description": "AZEC motif résiliation mapping"
      }
    }
  },
  "common_transformations": {
    "description": "Transformations applied to both AZ and AZEC after harmonization",
    "cdtre_cleanup": {
      "description": "Remove '*' prefix from CDTRE if present)",
      "column": "cdtre",
      "type": "regex_replace",
      "pattern": "^\\*(.{3})",
      "replacement": "$1"
    },
    "partnership_flags": {
      "description": "Partnership and special program flags",
      "transformations": [
        {
          "column": "top_partenariat",
          "type": "flag",
          "condition": "noint.isin(['4A6160', '4A6947', '4A6956'])"
        },
        {
          "column": "top_berlioz",
          "type": "flag",
          "condition": "noint == '4A5766'"
        }
      ]
    }
  },
  "fallback_logic": {
    "description": "Fallback coalescing for missing columns",
    "dtrcppr_fallback": {
      "column": "dtrcppr",
      "type": "coalesce",
      "sources": [
        "dtrcppr",
        "dtreffin"
      ]
    }
  }
}