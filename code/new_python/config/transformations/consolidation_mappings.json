{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "description": "Consolidation schema harmonization mappings - AZ and AZEC to common schema - aligned with SAS macros (PTF_MVTS_CONSOLIDATION_MACRO.sas & CODIFICATION_ISIC_CONSTRUCTION.sas)",
  "az_harmonization": {
    "description": "AZ data is already in target schema - minimal mapping needed (SAS OUTER UNION CORR section)",
    "rename": {
      "nopol": "nopol",
      "noint": "noint",
      "cdprod": "cdprod",
      "cseg": "cseg",
      "cssseg": "cssseg",
      "cdcoas": "cdcoass",
      "partcie": "part_cie",
      "primeto": "primes_ptf_intemp",
      "cotis_100": "primes_ptf_100_intemp"
    },
    "computed": {}
  },
  "azec_harmonization": {
    "description": "Map AZEC columns to match AZ schema for consolidation (SAS OUTER UNION CORR block)",
    "rename": {
      "police": "nopol",
      "produit": "cdprod",
      "intermed": "noint",
      "codecoas": "cdcoass",
      "partcie": "part_cie",
      "primeto": "primes_ptf_intemp",
      "cotis_100": "primes_ptf_100_intemp",
      "effetpol": "dtcrepol",
      "datfin": "dtresilp",
      "datresil": "dttraar",
      "poingest": "ptgst",
      "mtca": "mtca",
      "code_naf": "cdnaf",
      "code_tre": "cdtre",
      "motifres": "cdcasres",
      "nomcli": "nmclt",
      "lidirisq": "lidirisq"
    },
    "computed": {
      "nopolli1": {
        "type": "alias",
        "source": "police",
        "description": "AZEC uses same field for both NOPOL and NOPOLLI1 (SAS OUTER UNION CORR)"
      },
      "mois_echeance": {
        "type": "month_extract",
        "source": "dtechann",
        "description": "Extract month from anniversary date (SAS SELECT on AZ/AZEC)"
      },
      "jour_echeance": {
        "type": "day_extract",
        "source": "dtechann",
        "description": "Extract day from anniversary date (SAS SELECT on AZ/AZEC)"
      },
      "cdsitp": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC (SAS: CDSITP='')"
      },
      "cdreg": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC (SAS: CDREG='')"
      },
      "cdgecent": {
        "type": "constant",
        "value": null,
        "description": "Numeric missing for AZEC (SAS: .)"
      },
      "cdpolrvi": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC (SAS OUTER UNION CORR)"
      },
      "noclt": {
        "type": "constant",
        "value": null,
        "description": "Empty for AZEC in consolidation"
      },
      "cdfract": {
        "type": "constant",
        "value": null,
        "description": "Empty risk address/contract fields for AZEC"
      },
      "quarisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "nmrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "nmsrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "resrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "ruerisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "posrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "vilrisq": {
        "type": "constant",
        "value": null,
        "description": "Empty in AZEC"
      },
      "dteffan": {
        "type": "alias",
        "source": "effetpol",
        "description": "AZEC uses EFFETPOL for DTEFFAN (SAS)"
      },
      "dttraan": {
        "type": "alias",
        "source": "effetpol",
        "description": "AZEC uses EFFETPOL for DTTRAAN (SAS)"
      },
      "actprin": {
        "type": "constant",
        "value": null,
        "description": "AZ-only; AZEC default empty (SAS OUTER UNION CORR)"
      },
      "ctprvtrv": {
        "type": "constant",
        "value": null,
        "description": "Numeric missing (SAS: .)"
      },
      "mtsmpr": {
        "type": "constant",
        "value": null,
        "description": "Numeric missing (SAS: .)"
      },
      "lbnattrv": {
        "type": "constant",
        "value": null,
        "description": "AZ-only; AZEC default empty"
      },
      "nbrpt": {
        "type": "constant",
        "value": 0,
        "description": "No RPT logic in AZEC (SAS sets 0)"
      },
      "nbrpc": {
        "type": "constant",
        "value": 0,
        "description": "No RPC logic in AZEC (SAS sets 0)"
      },
      "primes_rpc": {
        "type": "constant",
        "value": 0,
        "description": "No RPC primes in AZEC"
      },
      "primes_rpt": {
        "type": "constant",
        "value": 0,
        "description": "No RPT primes in AZEC"
      },
      "mtcaenp": {
        "type": "constant",
        "value": 0,
        "description": "Capital field not in AZEC (SAS sets 0)"
      },
      "mtcasst": {
        "type": "constant",
        "value": 0,
        "description": "Capital field not in AZEC (SAS sets 0)"
      },
      "mtcavnt": {
        "type": "constant",
        "value": 0,
        "description": "Capital field not in AZEC (SAS sets 0)"
      },
      "cdnaf2008": {
        "type": "alias",
        "source": "code_naf",
        "description": "Temporary NAF2008 from AZEC (finalization handled by ISIC pipeline)"
      },
      "top_temp": {
        "type": "constant",
        "value": 0,
        "description": "Temporary flag - always 0 for AZEC (SAS)"
      },
      "cdmotres": {
        "type": "mapping",
        "source": "origres",
        "mapping": {
          "CL": "A",
          "AP": "C",
          "CI": "Z",
          "": null
        },
        "default": "X",
        "description": "AZEC motif résiliation mapping (SAS CASE)"
      }
    }
  },
  "common_transformations": {
    "description": "Transformations applied to both AZ and AZEC after harmonization (SAS parity)",
    "cdtre_cleanup": {
      "description": "Remove '*' prefix from CDTRE if present (SAS: substr(CDTRE,2,3))",
      "column": "cdtre",
      "type": "regex_replace",
      "pattern": "^\\*(.{3})",
      "replacement": "$1",
      "comment": "SAS: CASE substr(CDTRE, 1, 1) when '*' THEN substr(CDTRE, 2, 3) ELSE CDTRE"
    },
    "partnership_flags": {
      "description": "Partnership and special program flags (SAS L598-599)",
      "transformations": [
        {
          "column": "top_partenariat",
          "type": "flag",
          "condition": "noint.isin(['4A6160', '4A6947', '4A6956'])",
          "comment": "SAS: if NOINT in (4A6160,4A6947,4A6956) then TOP_PARTENARIAT=1"
        },
        {
          "column": "top_berlioz",
          "type": "flag",
          "condition": "noint == '4A5766'",
          "comment": "SAS: if NOINT=4A5766 then TOP_BERLIOZ=1"
        }
      ]
    }
  },
  "fallback_logic": {
    "description": "Fallback coalescing for missing columns (SAS: DTRCPPR from DTREFFIN)",
    "dtrcppr_fallback": {
      "column": "dtrcppr",
      "type": "coalesce",
      "sources": [
        "dtrcppr",
        "dtreffin"
      ],
      "comment": "SAS: if missing(DTRCPPR) and not missing(DTREFFIN) then DTRCPPR=DTREFFIN"
    }
  },
  "movement_column_mapping": {
    "description": "Column mapping for movement calculations (AFN, RES, RPT, RPC) — parity with SAS inputs",
    "az": {
      "creation_date": "dtcrepol",
      "effective_date": "dteffan",
      "termination_date": "dtresilp",
      "transfer_start": "dttraan",
      "transfer_end": "dttraar",
      "type_col1": "cdtypli1",
      "type_col2": "cdtypli2",
      "type_col3": "cdtypli3",
      "type_date1": "dttypli1",
      "type_date2": "dttypli2",
      "type_date3": "dttypli3"
    },
    "azec": {
      "creation_date": "poingest",
      "effective_date": "effetpol",
      "termination_date": "datresil",
      "transfer_start": null,
      "transfer_end": null,
      "type_col1": null,
      "type_col2": null,
      "type_col3": null,
      "type_date1": null,
      "type_date2": null,
      "type_date3": null
    }
  },
  "exposure_column_mapping": {
    "description": "Column mapping for exposure calculations (expo_ytd, expo_gli) — parity with SAS inputs",
    "az": {
      "creation_date": "dtcrepol",
      "termination_date": "dtresilp"
    },
    "azec": {
      "creation_date": "effetpol",
      "termination_date": "datfin"
    }
  }
}