{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "description": "AZ transformation configurations - Corrected to match SAS PTF_MVTS_AZ_MACRO.sas",
  "column_selection": {
    "description": "Columns to select from AZ bronze data - SAS: PTF_MVTS_AZ_MACRO.sas L54-115",
    "passthrough": [
      "cdprod",
      "nopol",
      "noclt",
      "nmclt",
      "noint",
      "dtcrepol",
      "cdnatp",
      "txcede",
      "ptgst",
      "dteffan",
      "dttraan",
      "dtresilp",
      "dttraar",
      "cdtypli1",
      "cdtypli2",
      "cdtypli3",
      "dttypli1",
      "dttypli2",
      "dttypli3",
      "cmarch",
      "cdsitp",
      "mtprprto",
      "prcdcie",
      "cdri",
      "cdcieori",
      "cdsitmgr",
      "cdgecent",
      "cdmotres",
      "cdpolrvi",
      "nopolli1",
      "cdcasres",
      "dtechann",
      "cdfract",
      "quarisq",
      "nmrisq",
      "nmsrisq",
      "resrisq",
      "ruerisq",
      "lidirisq",
      "posrisq",
      "vilrisq",
      "cdreg",
      "mtcapi1",
      "mtcapi2",
      "mtcapi3",
      "mtcapi4",
      "mtcapi5",
      "mtcapi6",
      "mtcapi7",
      "mtcapi8",
      "mtcapi9",
      "mtcapi10",
      "mtcapi11",
      "mtcapi12",
      "mtcapi13",
      "mtcapi14",
      "lbcapi1",
      "lbcapi2",
      "lbcapi3",
      "lbcapi4",
      "lbcapi5",
      "lbcapi6",
      "lbcapi7",
      "lbcapi8",
      "lbcapi9",
      "lbcapi10",
      "lbcapi11",
      "lbcapi12",
      "lbcapi13",
      "lbcapi14",
      "ctdeftra",
      "ctprvtrv",
      "dtouchan",
      "dtrcppr",
      "dtrectrx",
      "dtrcpre",
      "lbnattrv",
      "dstcsc",
      "lbqltsou",
      "actprin",
      "mtsmpr",
      "cdnaf",
      "cdtre",
      "cdactpro",
      "fncmaca",
      "mtcaf",
      "tydris1",
      "opapoffr",
      "cdpolqpl",
      "cdgrev",
      "ctduree"
    ],
    "rename": {
      "posacta": "posacta_ri",
      "rueacta": "rueacta_ri",
      "cediacta": "cediacta_ri",
      "nmacta": "nmacta",
      "csegt": "cseg",
      "cssegt": "cssseg",
      "cdtpcoa": "cdcoas",
      "fncmaca": "mtca"
    },
    "computed": {
      "tx": {
        "type": "coalesce_default",
        "source_col": "txcede",
        "default": 0
      },
      "top_coass": {
        "type": "flag_equality",
        "source_col": "cdpolqpl",
        "value": "1"
      }
    },
    "metadata": {
      "dircom": "AZ",
      "add_vision": true,
      "add_year_month": true
    }
  },
  "computed_fields": {
    "description": "Computed fields to apply after column selection - SAS: PTF_MVTS_AZ_MACRO.sas L238-243, L290 (NOTE: TOP_AOP moved to STEP 11 to match SAS L339-341 order)",
    "primeto": {
      "type": "expression",
      "formula": "mtprprto * (1 - tx / 100)",
      "description": "Total premium = Gross premium * (1 - Ceding rate %) - SAS L239"
    },
    "top_lta": {
      "type": "conditional",
      "conditions": [
        {
          "check": "(ctduree > 1) AND (tydris1 IN ('QAW', 'QBJ', 'QBK', 'QBB', 'QBM'))",
          "result": 1
        }
      ],
      "default": 0,
      "description": "Long Term Agreement flag - SAS L242-243. Contracts with duration > 1 year and specific risk types."
    },
    "top_temp": {
      "type": "flag_equality",
      "source_col": "cdnatp",
      "value": "T",
      "description": "Temporary contract flag - SAS L290. Identifies temporary nature contracts."
    },
    "top_revisable": {
      "type": "flag_equality",
      "source_col": "cdpolrvi",
      "value": "1",
      "description": "Revisable policy flag - SAS L77. Policies with revision clause (cdpolrvi='1')."
    }
  },
  "capital_extraction": {
    "description": "Extract capital amounts from lbcapi/mtcapi fields (SAS: PTF_MVTS_AZ_MACRO.sas L195-231)",
    "smp_100": {
      "keywords": [
        "SMP GLOBAL DU CONTRAT",
        "SMP RETENU",
        "SINISTRE MAXIMUM POSSIBLE"
      ],
      "label_prefix": "lbcapi",
      "amount_prefix": "mtcapi",
      "num_indices": 14
    },
    "lci_100": {
      "keywords": [
        "LCI GLOBAL DU CONTRAT",
        "CAPITAL REFERENCE OU LCI",
        "LCI IRD (DOM. DIRECTS+P.EXPLOIT)",
        "LIMITE CONTRACTUELLE INDEMNITE"
      ],
      "label_prefix": "lbcapi",
      "amount_prefix": "mtcapi",
      "num_indices": 14
    },
    "risque_direct": {
      "keywords": [
        "RISQUE DIRECT",
        "CAPITAUX DOMMAGES DIR"
      ],
      "exclude_keywords": [
        "SINIS MAX POSSIBLE RISQUE DIRECT"
      ],
      "label_prefix": "lbcapi",
      "amount_prefix": "mtcapi",
      "num_indices": 14
    },
    "perte_exp": {
      "keywords": [
        "PERTE EXPLOITATION (MARGE BRUTE)",
        "PERTE D EXPLOITATION",
        "PERTE D'EXPLOITATION",
        "CAPITAL PERTES EXPLOITATION",
        "CAPITAUX TOTAUX P.E.",
        "PERTE EXPLOITATION/AUT. DOM. MAT",
        "PERTES D'EXPLOITATION",
        "PERTES EXPLOITATION"
      ],
      "label_prefix": "lbcapi",
      "amount_prefix": "mtcapi",
      "num_indices": 14
    }
  },
  "coassurance": {
    "description": "Coassurance type and part company calculation - SAS L64-74",
    "column": "coass",
    "conditions": [
      {
        "check": "cdpolqpl == '1' and cdcoas in ['3', '6']",
        "result": "APERITION"
      },
      {
        "check": "cdpolqpl == '1' and cdcoas in ['4', '5']",
        "result": "COASS. ACCEPTEE"
      },
      {
        "check": "cdpolqpl == '1' and cdcoas == '8'",
        "result": "ACCEPTATION INTERNATIONALE"
      },
      {
        "check": "cdpolqpl == '1' and cdcoas not in ['3', '4', '5', '6', '8']",
        "result": "AUTRES"
      },
      {
        "check": "cdpolqpl != '1'",
        "result": "SANS COASSURANCE"
      }
    ],
    "default": "SANS COASSURANCE",
    "part_cie": {
      "column": "partcie",
      "logic": "when cdpolqpl != '1' then 1 else prcdcie / 100"
    }
  },
  "revision_criteria": {
    "description": "Revision criteria mapping from CDGREV - SAS L78-96",
    "source_col": "cdgrev",
    "mapping": {
      "20": "20_SANS_PROV_MANUEL ",
      "21": "21_PROV_FIXE_MANUEL ",
      "22": "22_PROV_VAR_MANUEL ",
      "23": "23_SANS_REVISION ",
      "24": "24_REV_FIN_CHANTIER ",
      "30": "30_SANS_PROV_MANUEL ",
      "31": "31_PROV_FIXE_MANUEL ",
      "32": "32_PROV_VAR_MANUEL ",
      "40": "40_SANS_PROV_AUTOMAT",
      "41": "41_PROV_FIXE_AUTOMAT",
      "42": "42_PROV_VAR_AUTOMAT ",
      "43": "43_SANS_REV_AUTOMAT ",
      "80": "80_REVISION_SPECIALE",
      "90": "90_SANS_PROV_AUTOMAT",
      "91": "91_PROV_FIXE_AUTOMAT",
      "92": "92_PROV_VAR_AUTOMAT "
    },
    "default": ""
  },
  "movements": {
    "description": "Movement calculations (AFN, RES, RPT, RPC, NBPTF) - SAS L249-292",
    "column_mapping": {
      "creation_date": "dtcrepol",
      "effective_date": "dteffan",
      "termination_date": "dtresilp",
      "transfer_start": "dttraan",
      "transfer_end": "dttraar",
      "type_col1": "cdtypli1",
      "type_col2": "cdtypli2",
      "type_col3": "cdtypli3",
      "type_date1": "dttypli1",
      "type_date2": "dttypli2",
      "type_date3": "dttypli3"
    }
  },
  "exposures": {
    "description": "Exposure calculations (expo_ytd, expo_gli) - SAS L298-311",
    "column_mapping": {
      "creation_date": "dtcrepol",
      "termination_date": "dtresilp"
    }
  }
}